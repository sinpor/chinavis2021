<template lang="en">
    <div class="page-conainer">
        <div class="chart">
            <div class="chart-container" ref="chart">
            </div>
        </div>
    </div>
</template>
<script>
import dayjs from "dayjs"
import moment from "moment"
import * as d3 from "d3"
import * as echarts from "echarts"

export default {
	components: {},
	async mounted() {
		console.log(this.$route.params)
		await this.initData()
		this.initChart()
	},
	data() {
		return {
			sourceData: [],
		}
	},
	methods: {
		initData() {
			const { params } = this.$route
			const { date, data } = params
			// const data = [
			// 	[107.57, 29.28],
			// 	[107.73, 29.28],
			// 	[107.88, 29.27],
			// 	[108.04, 29.27],
			// 	[108.19, 29.27],
			// 	[108.35, 29.26],
			// 	[108.5, 29.26],
			// 	[108.66, 29.25],
			// 	[108.82, 29.25],
			// 	[108.97, 29.24],
			// 	[109.13, 29.24],
			// 	[109.28, 29.23],
			// 	[109.44, 29.23],
			// 	[109.59, 29.22],
			// 	[109.75, 29.21],
			// 	[109.9, 29.21],
			// 	[107.57, 29.42],
			// 	[107.73, 29.41],
			// 	[107.89, 29.41],
			// 	[108.04, 29.41],
			// 	[108.2, 29.4],
			// 	[108.35, 29.4],
			// 	[108.51, 29.39],
			// 	[108.67, 29.39],
			// 	[108.82, 29.38],
			// 	[108.98, 29.38],
			// 	[109.13, 29.37],
			// 	[109.29, 29.37],
			// 	[109.44, 29.36],
			// 	[109.6, 29.36],
			// 	[109.76, 29.35],
			// 	[109.91, 29.34],
			// 	[107.58, 29.55],
			// 	[107.73, 29.55],
			// 	[107.89, 29.54],
			// 	[108.05, 29.54],
			// 	[108.2, 29.54],
			// 	[108.36, 29.53],
			// 	[108.51, 29.53],
			// 	[108.67, 29.52],
			// 	[108.83, 29.52],
			// 	[108.98, 29.51],
			// 	[109.14, 29.51],
			// 	[109.29, 29.5],
			// 	[109.45, 29.5],
			// 	[109.61, 29.49],
			// 	[109.76, 29.49],
			// 	[109.92, 29.48],
			// 	[107.58, 29.69],
			// 	[107.74, 29.68],
			// 	[107.89, 29.68],
			// 	[108.05, 29.68],
			// 	[108.21, 29.67],
			// 	[108.36, 29.67],
			// 	[108.52, 29.66],
			// 	[108.68, 29.66],
			// 	[108.83, 29.65],
			// 	[108.99, 29.65],
			// 	[109.14, 29.64],
			// 	[109.3, 29.64],
			// 	[109.46, 29.63],
			// 	[109.61, 29.63],
			// 	[109.77, 29.62],
			// 	[109.93, 29.62],
			// 	[107.59, 29.82],
			// 	[107.74, 29.82],
			// 	[107.9, 29.82],
			// 	[108.06, 29.81],
			// 	[108.21, 29.81],
			// 	[108.37, 29.8],
			// 	[108.52, 29.8],
			// 	[108.68, 29.8],
			// 	[108.84, 29.79],
			// 	[108.99, 29.79],
			// 	[109.15, 29.78],
			// 	[109.31, 29.77],
			// 	[109.46, 29.77],
			// 	[109.62, 29.76],
			// 	[109.78, 29.76],
			// 	[109.93, 29.75],
			// 	[107.59, 29.96],
			// 	[107.75, 29.96],
			// 	[107.9, 29.95],
			// 	[108.06, 29.95],
			// 	[108.22, 29.94],
			// 	[108.37, 29.94],
			// 	[108.53, 29.94],
			// 	[108.69, 29.93],
			// 	[108.84, 29.93],
			// 	[109, 29.92],
			// 	[109.16, 29.92],
			// 	[109.31, 29.91],
			// 	[109.47, 29.91],
			// 	[109.63, 29.9],
			// 	[109.78, 29.89],
			// 	[109.94, 29.89],
			// 	[107.59, 30.1],
			// 	[107.75, 30.09],
			// 	[107.91, 30.09],
			// 	[108.06, 30.08],
			// 	[108.22, 30.08],
			// 	[108.38, 30.08],
			// 	[108.54, 30.07],
			// 	[108.69, 30.07],
			// 	[108.85, 30.06],
			// 	[109.01, 30.06],
			// 	[109.16, 30.05],
			// 	[109.32, 30.05],
			// 	[109.48, 30.04],
			// 	[109.63, 30.04],
			// 	[109.79, 30.03],
			// 	[109.95, 30.02],
			// 	[107.6, 30.23],
			// 	[107.75, 30.23],
			// 	[107.91, 30.22],
			// 	[108.07, 30.22],
			// 	[108.23, 30.22],
			// 	[108.38, 30.21],
			// 	[108.54, 30.21],
			// 	[108.7, 30.2],
			// 	[108.86, 30.2],
			// 	[109.01, 30.19],
			// 	[109.17, 30.19],
			// 	[109.33, 30.18],
			// 	[109.48, 30.18],
			// 	[109.64, 30.17],
			// 	[109.8, 30.16],
			// 	[109.96, 30.16],
			// 	[107.6, 30.37],
			// 	[107.76, 30.36],
			// 	[107.92, 30.36],
			// 	[108.07, 30.36],
			// 	[108.23, 30.35],
			// 	[108.39, 30.35],
			// 	[108.55, 30.34],
			// 	[108.7, 30.34],
			// 	[108.86, 30.33],
			// 	[109.02, 30.33],
			// 	[109.18, 30.32],
			// 	[109.33, 30.32],
			// 	[109.49, 30.31],
			// 	[109.65, 30.31],
			// 	[109.81, 30.3],
			// 	[109.96, 30.29],
			// 	[107.6, 30.5],
			// 	[107.76, 30.5],
			// 	[107.92, 30.5],
			// 	[108.08, 30.49],
			// 	[108.24, 30.49],
			// 	[108.39, 30.48],
			// 	[108.55, 30.48],
			// 	[108.71, 30.47],
			// 	[108.87, 30.47],
			// 	[109.02, 30.46],
			// 	[109.18, 30.46],
			// 	[109.34, 30.45],
			// 	[109.5, 30.45],
			// 	[109.65, 30.44],
			// 	[109.81, 30.44],
			// 	[109.97, 30.43],
			// 	[107.61, 30.64],
			// 	[107.77, 30.64],
			// 	[107.92, 30.63],
			// 	[108.08, 30.63],
			// 	[108.24, 30.62],
			// 	[108.4, 30.62],
			// 	[108.56, 30.62],
			// 	[108.71, 30.61],
			// 	[108.87, 30.61],
			// 	[109.03, 30.6],
			// 	[109.19, 30.6],
			// 	[109.35, 30.59],
			// 	[109.5, 30.58],
			// 	[109.66, 30.58],
			// 	[109.82, 30.57],
			// 	[109.98, 30.57],
			// 	[107.61, 30.77],
			// 	[107.77, 30.77],
			// 	[107.93, 30.77],
			// 	[108.09, 30.76],
			// 	[108.25, 30.76],
			// 	[108.4, 30.76],
			// 	[108.56, 30.75],
			// 	[108.72, 30.75],
			// 	[108.88, 30.74],
			// 	[109.04, 30.74],
			// 	[109.19, 30.73],
			// 	[109.35, 30.73],
			// 	[109.51, 30.72],
			// 	[109.67, 30.71],
			// 	[109.83, 30.71],
			// 	[109.98, 30.7],
			// 	[107.62, 30.91],
			// 	[107.77, 30.91],
			// 	[107.93, 30.9],
			// 	[108.09, 30.9],
			// 	[108.25, 30.9],
			// 	[108.41, 30.89],
			// 	[108.57, 30.89],
			// 	[108.73, 30.88],
			// 	[108.88, 30.88],
			// 	[109.04, 30.87],
			// 	[109.2, 30.87],
			// 	[109.36, 30.86],
			// 	[109.52, 30.86],
			// 	[109.68, 30.85],
			// 	[109.83, 30.84],
			// 	[109.99, 30.84],
			// 	[107.62, 31.05],
			// 	[107.78, 31.04],
			// 	[107.94, 31.04],
			// 	[108.1, 31.04],
			// 	[108.25, 31.03],
			// 	[108.41, 31.03],
			// 	[108.57, 31.02],
			// 	[108.73, 31.02],
			// 	[108.89, 31.01],
			// 	[109.05, 31.01],
			// 	[109.21, 31],
			// 	[109.37, 31],
			// 	[109.52, 30.99],
			// 	[109.68, 30.99],
			// 	[109.84, 30.98],
			// 	[110, 30.97],
			// 	[107.62, 31.18],
			// 	[107.78, 31.18],
			// 	[107.94, 31.18],
			// 	[108.1, 31.17],
			// 	[108.26, 31.17],
			// 	[108.42, 31.16],
			// 	[108.58, 31.16],
			// 	[108.74, 31.15],
			// 	[108.9, 31.15],
			// 	[109.05, 31.14],
			// 	[109.21, 31.14],
			// 	[109.37, 31.13],
			// 	[109.53, 31.13],
			// 	[109.69, 31.12],
			// 	[109.85, 31.12],
			// 	[110.01, 31.11],
			// 	[107.63, 31.32],
			// 	[107.79, 31.32],
			// 	[107.95, 31.31],
			// 	[108.11, 31.31],
			// 	[108.26, 31.3],
			// 	[108.42, 31.3],
			// 	[108.58, 31.3],
			// 	[108.74, 31.29],
			// 	[108.9, 31.29],
			// 	[109.06, 31.28],
			// 	[109.22, 31.28],
			// 	[109.38, 31.27],
			// 	[109.54, 31.26],
			// 	[109.7, 31.26],
			// 	[109.86, 31.25],
			// 	[110.01, 31.25],
			// ]
			// const date = "2013/01/01"
			this.date = date
			if (!date) return
			//   const month = dayjs(date, "YYYY/MM/DD").format('M');
			const m = moment(date, "YYYY/MM/DD").add(-2, "days")
			const num = m.endOf("month").format("D")
			this.dataKeys = ["PM2.5", "PM10", "SO2", "NO2", "CO", "O3", "AQI"]
			const promsieArr = new Array(Number(num)).fill().map((_, d) => {
				const fileName = dayjs(date, "YYYYMMDD")
					.startOf("month")
					.add(d, "d")
					.format("YYYYMMDD")
				return this.$http.get(`${fileName}00`).then((res) => {
					const useData = res.filter((d1) => {
						return data.find(
							(d2) => d2[0] === d1.lon && d2[1] === d1.lat
						)
					})
					const obj = {}
					this.dataKeys.forEach((k) => {
						obj[k] = d3.mean(useData, (d) => d[k])
					})
					obj.index = d
					return obj
				})
			})
			return Promise.all(promsieArr).then((res) => {
				console.log(res)
				this.sourceData = res
			})
		},
		initChart() {
			this.chart = echarts.init(this.$refs.chart)
			const options = {
				title: {
					text: "所选区域污染物",
					subtext: dayjs(this.date, "YYYY/MM/DD").format(
						"YYYY年MM月"
					),
					left: 24,
					top: 50,
					textStyle: {
						fontSize: 32,
					},
					subtextStyle: {
						fontSize: 18,
					},
				},
				tooltip: {},
				legend: {
					bottom: 30,
					left: 24,
					// orient: "vertical",
				},
				grid: {
					top: 180,
					bottom: 150,
					left: 50,
					width: "20%",
				},
				xAxis: {
					type: "category",
					data: this.sourceData.map((d) =>
						dayjs(this.date, "YYYY/MM/DD")
							.startOf("month")
							.add(d.index, "day")
							.format("YYYY/MM/DD")
					),
				},
				yAxis: {
					name: "AQI",
				},
				angleAxis: {
					type: "category",
					data: this.sourceData.map((d) =>
						dayjs(this.date, "YYYY/MM/DD")
							.startOf("month")
							.add(d.index, "day")
							.format("YYYY/MM/DD")
					),
					boundaryGap: false,
				},
				radiusAxis: {},
				polar: {
					center: ["60%", "50%"],
					radius: [50, "80%"],
				},
				series: [
					...this.dataKeys.map((d) => {
						return {
							type: "bar",
							data: this.sourceData.map((d1) => d1[d]),
							coordinateSystem: "polar",
							name: d,
							id: d,
							stack: "a",
							emphasis: {
								focus: "series",
							},
						}
					}),
					{
						type: "line",
						data: this.sourceData.map((d1) => d1.AQI),
					},
				],
			}
			this.chart.setOption(options)
		},
	},
}
</script>
<style lang="less">
.page-conainer {
	width: 100%;
	height: 100%;
	display: flex;
	.tool {
		width: 200px;
		height: 100%;
		margin-right: 24px;
	}
	.chart {
		flex: 1;
		height: 100%;
	}
}
</style>
